<div class="flex flex-column gap-4 w-full p-3 md:p-4 surface-ground">
  
  <div class="grid grid-nogutter gap-3 md:gap-4">
    <div *ngFor="let metric of metrics" class="col-12 md:col-6 lg:col-3">
      <p-card styleClass="h-full shadow-2 border-round-xl border-none">
        <div class="flex align-items-center justify-content-between">
          <div>
            <div class="text-500 text-sm mb-1 font-medium">{{ metric.title }}</div>
            <div class="flex align-items-end gap-2">
              <div class="text-3xl font-bold text-blue-600">{{ metric.value }}</div>
            </div>
            <div class="text-xs text-blue-400 mt-1 font-medium">{{ metric.subtext }}</div>
          </div>
          <div class="w-3rem h-3rem border-round bg-gray-50 flex align-items-center justify-content-center border-1 border-100">
            <i [class]="metric.icon" class="text-xl text-700"></i>
          </div>
        </div>
      </p-card>
    </div>
  </div>

  <div class="card bg-white border-round-xl shadow-3 overflow-hidden">
    
    <div class="flex flex-column md:flex-row flex-wrap align-items-center justify-content-between p-3 border-bottom-1 border-100 gap-3">
        <div class="text-blue-600 font-bold text-xl flex align-items-center w-full md:w-auto">
            <i class="pi pi-history mr-2"></i> 
            <span>บันทึกกิจกรรม</span>
        </div>
        
        <div class="flex flex-column md:flex-row align-items-center gap-2 w-full md:w-auto">
            <p-calendar [(ngModel)]="selectedDate" (onSelect)="loadDashboardData()" placeholder="วันที่" [showIcon]="true" styleClass="w-full md:w-10rem p-inputtext-sm"></p-calendar>
            
            <p-iconField iconPosition="right" class="w-full md:w-auto">
                <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
                <input type="text" pInputText placeholder="ค้นหากิจกรรม..." class="p-inputtext-sm w-full md:w-15rem" />
            </p-iconField>
            
            <p-button label="Export" icon="pi pi-download" size="small" [outlined]="true" styleClass="w-full md:w-auto"></p-button>
        </div>
    </div>

    <p-tabView>
        <p-tabPanel>
            <ng-template pTemplate="header">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-check-circle text-green-500"></i>
                    <span class="font-bold hidden sm:inline">กิจกรรมปกติ (Normal)</span> <span class="font-bold sm:hidden">Normal</span>
                    <p-badge [value]="normalActivities.length.toString()" severity="success"></p-badge>
                </div>
            </ng-template>

            <p-table [value]="normalActivities" [paginator]="true" [rows]="8" responsiveLayout="scroll" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr class="text-sm bg-gray-50 white-space-nowrap">
                        <th style="min-width: 100px">เวลา</th>
                        <th style="min-width: 100px">Type</th>
                        <th style="min-width: 150px">Action</th>
                        <th style="min-width: 150px">User</th>
                        <th style="min-width: 200px" class="hidden lg:table-cell">Detail</th>
                        <th style="min-width: 100px">Status</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-log>
                    <tr class="text-sm hover:surface-50 transition-colors white-space-nowrap">
                        <td class="font-semibold text-600">{{ log.time }}</td>
                        <td>
                            <div class="flex align-items-center gap-2 text-700">
                                <i [class]="getActivityIcon(log.type)"></i>
                                <span class="uppercase text-xs font-bold border-round px-2 py-1 hidden sm:inline-block" 
                                      [ngClass]="log.logType === 'revision' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'">
                                    {{ log.logType === 'revision' ? 'DATA' : 'EVENT' }}
                                </span>
                            </div>
                        </td>
                        <td class="font-medium text-800">{{ log.action }}</td>
                        <td>
                            <div class="flex align-items-center gap-2 cursor-pointer text-blue-600 hover:text-blue-800" 
                                 (click)="viewUserHistory(log.user)" pTooltip="Click to view history">
                                <p-avatar icon="pi pi-user" shape="circle" size="normal" styleClass="bg-blue-50 text-blue-500 flex-shrink-0"></p-avatar>
                                <span class="font-semibold underline">{{ log.user }}</span>
                            </div>
                        </td>
                        <td class="text-600 hidden lg:table-cell text-overflow-ellipsis overflow-hidden" style="max-width: 200px">
                            {{ log.detail || log.entityId }}
                        </td>
                        <td><p-tag [value]="'Success'" severity="success" [rounded]="true"></p-tag></td>
                    </tr>
                </ng-template>
            </p-table>
        </p-tabPanel>

        <p-tabPanel>
            <ng-template pTemplate="header">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-exclamation-triangle text-red-500"></i>
                    <span class="font-bold text-red-600 hidden sm:inline">สิ่งที่ต้องตรวจสอบ (Abnormal)</span>
                    <span class="font-bold text-red-600 sm:hidden">Abnormal</span>
                    <p-badge [value]="abnormalActivities.length.toString()" severity="danger"></p-badge>
                </div>
            </ng-template>

            <p-table [value]="abnormalActivities" [paginator]="true" [rows]="8" responsiveLayout="scroll" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr class="text-sm bg-red-50 white-space-nowrap">
                        <th style="min-width: 100px">เวลา</th>
                        <th style="min-width: 100px">Type</th>
                        <th style="min-width: 150px">Action</th>
                        <th style="min-width: 150px">User</th>
                        <th style="min-width: 200px" class="hidden lg:table-cell">Detail</th>
                        <th style="min-width: 100px">Status</th>
                        <th style="min-width: 100px">Manage</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-log>
                    <tr class="text-sm hover:bg-red-50 transition-colors white-space-nowrap">
                        <td class="font-bold text-red-600">{{ log.time }}</td>
                        <td>
                            <div class="flex align-items-center gap-2 text-red-700 font-medium">
                                <i [class]="getActivityIcon(log.type)"></i>
                                <span class="uppercase text-xs font-bold border-round px-2 py-1 hidden sm:inline-block" 
                                      [ngClass]="log.logType === 'revision' ? 'bg-orange-100 text-orange-600' : 'bg-red-100 text-red-600'">
                                    {{ log.logType === 'revision' ? 'DATA' : 'EVENT' }}
                                </span>
                            </div>
                        </td>
                        <td class="font-bold text-800">{{ log.action }}</td>
                        <td>
                             <div class="flex align-items-center gap-2 cursor-pointer text-blue-600 hover:text-blue-800" 
                                  (click)="viewUserHistory(log.user)">
                                <span>{{ log.user }}</span>
                             </div>
                        </td>
                        <td class="text-red-600 hidden lg:table-cell">{{ log.detail || log.entityId }}</td>
                        <td>
                            <p-tag [value]="log.status === 'denied' ? 'Denied' : 'Error'" 
                                   [severity]="getStatusSeverity(log.status)" [rounded]="true"></p-tag>
                        </td>
                        <td>
                            <p-button icon="pi pi-search" [text]="true" [rounded]="true" severity="danger" size="small" label="Check"></p-button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-tabPanel>
    </p-tabView>
  </div>
</div>

<p-sidebar [(visible)]="historyVisible" position="right" styleClass="w-full md:w-30rem">
    <div class="flex flex-column h-full">
        <div class="flex align-items-center gap-3 mb-4 pb-3 border-bottom-1 border-gray-200 bg-gray-50 -m-3 p-4">
            <p-avatar icon="pi pi-user" size="large" shape="circle" styleClass="bg-blue-600 text-white shadow-3 flex-shrink-0"></p-avatar>
            <div class="overflow-hidden">
                <div class="text-xl font-bold text-800 white-space-nowrap text-overflow-ellipsis">{{ currentUser }}</div>
                <div class="text-500 text-sm flex align-items-center gap-2">
                    <i class="pi pi-history"></i> Unified History Log
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-1">
            <div *ngIf="selectedUserHistory.length === 0" class="text-center p-4 text-500">
                No history found.
            </div>

            <div *ngFor="let log of selectedUserHistory" class="mb-4 p-0 surface-card border-round-xl shadow-2 overflow-hidden border-1 border-gray-200">
                
                <div class="flex justify-content-between align-items-center p-3"
                     [ngClass]="log.category === 'normal' ? 'bg-gray-50' : 'bg-red-50'">
                    <div class="flex align-items-center gap-2 overflow-hidden">
                        <i [class]="getActivityIcon(log.type)" class="text-lg flex-shrink-0"></i>
                        <span class="font-bold text-700 white-space-nowrap text-overflow-ellipsis">{{ log.action }}</span>
                    </div>
                    <div class="flex flex-column align-items-end flex-shrink-0 ml-2">
                        <span class="text-xs font-mono text-500">{{ log.time }}</span>
                        <span class="text-[10px] font-bold px-2 border-round text-white mt-1"
                              [ngClass]="log.logType === 'revision' ? 'bg-orange-500' : 'bg-blue-500'">
                            {{ log.logType === 'revision' ? 'UPDATE' : 'ACT' }}
                        </span>
                    </div>
                </div>
                
                <div class="p-3">
                    
                    <div *ngIf="log.logType === 'revision'">
                        <div class="text-xs text-500 mb-2 font-mono">Entity ID: {{ log.entityId }}</div>
                        <div class="border-round bg-white border-1 border-gray-200 overflow-x-auto">
                            <table class="w-full text-sm" style="border-collapse: collapse; min-width: 250px;">
                                <thead class="bg-gray-100 text-600 text-xs border-bottom-1 border-gray-200">
                                    <tr>
                                        <th class="p-2 text-left">Field</th>
                                        <th class="p-2 text-left text-red-400">Old</th>
                                        <th class="p-2 text-left text-green-600">New</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let change of log.changes" class="border-bottom-1 border-gray-100 last:border-none">
                                        <td class="p-2 font-semibold text-700">{{ change.field }}</td>
                                        <td class="p-2 text-red-400 line-through opacity-70">{{ change.old || 'null' }}</td>
                                        <td class="p-2 text-green-600 font-medium">{{ change.new }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div *ngIf="log.logType === 'activity'">
                        <div class="grid grid-nogutter bg-blue-50 border-round p-2 text-sm text-700">
                            <div class="col-12 flex align-items-center mb-2">
                                <i class="pi pi-map-marker text-blue-500 mr-2"></i>
                                <span class="font-semibold mr-2">Loc:</span> 
                                <span class="text-overflow-ellipsis overflow-hidden white-space-nowrap">{{ log.meta?.location }}</span>
                            </div>
                            <div class="col-12 flex align-items-center mb-2">
                                <i class="pi pi-mobile text-blue-500 mr-2"></i>
                                <span class="font-semibold mr-2">Dev:</span> 
                                <span class="text-overflow-ellipsis overflow-hidden white-space-nowrap">{{ log.meta?.device }}</span>
                            </div>
                            <div class="col-12 flex align-items-center">
                                <i class="pi pi-shield text-blue-500 mr-2"></i>
                                <span class="font-semibold mr-2">Result:</span> 
                                <span [ngClass]="log.status === 'success' ? 'text-green-600' : 'text-red-600 font-bold'">
                                    {{ log.meta?.verification }}
                                </span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="mt-auto pt-3 border-top-1 border-gray-200 text-right">
            <p-button label="Close" icon="pi pi-times" [text]="true" severity="secondary" (click)="historyVisible = false"></p-button>
        </div>
    </div>
</p-sidebar>


<p-calendar
  [(ngModel)]="selectedDate"
  (onSelect)="loadDashboardData()"
  ...
></p-calendar>
